name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "version"
        required: false
        type: string
      build:
        description: "platform"
        required: true
        type: choice
        default: "all"
        options:
          - all
          - linux
          - windows
          - darwin
          - android
  schedule:
    - cron: "*/10 * * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ inputs.build }}
  cancel-in-progress: true

permissions:
  actions: write

env:
  UPSTREAM_REPO: SagerNet/sing-box
  UPSTREAM_REF: dev-next
  UPSTREAM_BUILD: /.github/workflows/build.yml
  UPDATE_RELEASE: false
  # Áªü‰∏ÄÁöÑ GitHub API ÈÖçÁΩÆ
  GITHUB_API_BASE: https://api.github.com/repos/${{ github.repository }}
  GITHUB_API_HEADERS: >-
    -H "Accept: application/vnd.github+json"
    -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"
    -H "X-GitHub-Api-Version: 2022-11-28"
  FUNC_WORKFLOW: |
    # Áªü‰∏ÄÁöÑ API Ë∞ÉÁî®ÂáΩÊï∞
    github_api_call()
    {
        local method="${1:-GET}"
        local endpoint="$2"
        local silent="${3:-false}"
        local base_url="${GITHUB_API_BASE}"
        
        # Â¶ÇÊûú endpoint ‰ª• https:// ÂºÄÂ§¥ÔºåÂàô‰ΩøÁî®ÂÆåÊï¥ URL
        if echo "$endpoint" | grep -q "^https://"; then
            base_url=""
        fi
        
        local curl_opts="-s"
        [ "$method" != "GET" ] && curl_opts="$curl_opts -X $method"
        [ "$silent" = "true" ] && curl_opts="$curl_opts -o /dev/null"
        
        curl $curl_opts "${base_url}${endpoint}" $GITHUB_API_HEADERS
    }

    workflow_list()
    {
        github_api_call "GET" "/actions/runs?${1}"
    }

    workflow_cancel()
    {
        github_api_call "POST" "/actions/runs/${{ github.run_id }}/cancel" "true"

        sleep ${1:-30}
        printf '%s\n' "üîÑ Workflow cancellation timeout reached, forcing exit"
        exit 2
    }

    workflow_delete()
    {
        printf '%*s%s' "${2:-3}" "" "- Deleting run ${1} ... "

        github_api_call "DELETE" "/actions/runs/${1}" "true"

        i=0
        while [ $i -lt 30 ]
        do
            if ! github_api_call "GET" "/actions/runs/${1}" "true"
            then
                printf '%s\n' "‚úÖ"
                return 0
            fi

            sleep 1
            : $(( i+=1 ))
        done

        printf '%s\n' "‚ùå"
    }

jobs:
  compare_release:
    name: Compare release
    runs-on: ubuntu-latest
    outputs:
      upstream_name: ${{ steps.compare_release.outputs.upstream_name }}
      upstream_tag: ${{ steps.compare_release.outputs.upstream_tag }}
      local_name: ${{ steps.compare_release.outputs.local_name }}
      local_tag: ${{ steps.compare_release.outputs.local_tag }}
      matrix: ${{ steps.get_matrix.outputs.matrix }}
    steps:
      - name: Compare release
        id: compare_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_VERSION: ${{ inputs.version }}
          FUNC_COMPARE_RELEASE: |
            get_release()
            {
                local repo=$1
                local tags=${2:+tags/}${2:-latest}
                local api_url="https://api.github.com/repos/${repo}/releases/${tags}"
                
                github_api_call "GET" "$api_url" | \
                jq -crM '
                    .name // "None",
                    .tag_name // "None",
                    .published_at // "None"
                ' 2>/dev/null || \
                printf '%s\n' "None" "None" "None"
            }

            vercomp()
            {
                ver1=$1
                ver2=$2

                [ "$ver1" = "$ver2" ] && return 0

                [ "$ver2" = "None" ] && return 1

                IFS=.
                set -- $ver1 $ver2
                pad=
                i=0
                while [ $i -lt $# ]
                do
                    pad=$pad.0
                    : $(( i+=1 ))
                done

                set -- $ver2
                for v in $ver1 $pad
                do
                    unset IFS

                    num1=${v:-0}
                    num2=${1:-0}
                    if [ $num1 -lt $num2 ]
                    then
                        return 1
                    elif [ $num1 -gt $num2 ]
                    then
                        return 2
                    elif [ $# -eq 0 ]
                    then
                        return 0
                    fi
                    shift
                done
            }
        run: |
          . /dev/stdin << EOF
          $FUNC_WORKFLOW
          $FUNC_COMPARE_RELEASE
          EOF

          IFS="
          "
          set -- $(
              INPUT_VERSION=${INPUT_VERSION:+v${INPUT_VERSION#v}}
              get_release "$UPSTREAM_REPO" "$INPUT_VERSION"
              get_release "${{ github.repository }}" "$INPUT_VERSION"
          )

          cat << EOF
          Event trigger: ${{ github.event_name }}

          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Release Comparison                                           ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ Repository  ‚îÇ Name       ‚îÇ Tag        ‚îÇ Date                 ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ Upstream    ‚îÇ $( printf '%-10s ‚îÇ %-10s ‚îÇ %-20s ‚îÇ\n' "$1" "$2" "$3" )
          ‚îÇ Local       ‚îÇ $( printf '%-10s ‚îÇ %-10s ‚îÇ %-20s ‚îÇ\n' "$4" "$5" "$6" )
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

          EOF

          upstream_name=$1
          upstream_tag=$2
          local_name=$4
          local_tag=$5

          if [ "$upstream_name" = "None" ]
          then
              printf '%s\n' "‚ùå Upstream not found: ${INPUT_VERSION:-latest}"
              exit 1
          fi

          r=${INPUT_VERSION:+1}
          vercomp "$upstream_name" "$local_name" && r=${r:-0}0 || r=${r:-0}$?

          case "$r" in
              10)
                  printf '%s\n' "üöÄ Update release: $upstream_name"
                  UPDATE_RELEASE=true
                  ;;
              11|01)
                  printf '%s\n' "üöÄ New version available: $upstream_name"
                  UPDATE_RELEASE=false
                  ;;
              00|02)
                  printf '%s\n' "‚úÖ Already up to date"
                  workflow_cancel
                  exit 0
                  ;;
              *)
                  printf '%s\n' "‚ùå Unexpected case: $r"
                  exit 1
                  ;;
          esac

          printf '%s\n' "upstream_name=$upstream_name" \
                        "upstream_tag=$upstream_tag" \
                        "local_name=$local_name" \
                        "local_tag=$local_tag" >> "$GITHUB_OUTPUT"

          printf '%s\n' "UPDATE_RELEASE=$UPDATE_RELEASE" >> "$GITHUB_ENV"
      - name: Get build matrix
        id: get_matrix
        env:
          INPUT_BUILD: ${{ inputs.build }}
        run: |
          UPSTREAM_BUILD=${UPSTREAM_REPO}/raw/${UPSTREAM_REF}${UPSTREAM_BUILD}

          if ! matrix=$(
              curl -fsSL "https://github.com/$UPSTREAM_BUILD" | \
              yq -rM '.jobs.build.strategy.matrix.include | @json' | \
              jq -e -crM --arg os "${INPUT_BUILD:-all}" '
                  if $os == "all" then . else map(select(.os == $os)) end |
                  if length > 0 then . else empty end
              '
          )
          then
              printf '%s\n' "‚ùå Upstream build not found: ${INPUT_BUILD:-all}"
              exit 1
          fi

          cat << EOF
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Build Matrix                                                                                            ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ os         ‚îÇ arch                                                                                       ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          $(
              printf '%s' "$matrix" | \
              jq -r '
                  group_by(.os) |
                  sort_by(.[0].os) |
                  .[] |
                  "‚îÇ " +
                  (.[0].os + " " * 10)[:10] +
                  " ‚îÇ " +
                  ([.[].arch] | unique | join(", ") | . + " " * 90)[:90] +
                  " ‚îÇ"
              '
          )
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          EOF

          printf '%s\n' "matrix=$matrix" >> "$GITHUB_OUTPUT"
      - name: Cleanup
        if: ${{ cancelled() && github.event_name == 'schedule' }}
        run: |
          . /dev/stdin << EOF
          $FUNC_WORKFLOW
          EOF

          printf '%s\n' "üóëÔ∏è Deleting workflow runs ..."

          workflow_list "event=schedule&status=cancelled" | \
          jq -r '
              .workflow_runs[] |
              select(.id != ${{ github.run_id }}) |
              .id
          ' | \
          while read -r run_id
          do
              workflow_delete "$run_id"
          done

          printf '%s\n' "‚úÖ Cleanup complete"
  build:
    name: Build binary
    runs-on: ubuntu-latest
    needs:
      - compare_release
    strategy:
      matrix:
        include: ${{ fromJson(needs.compare_release.outputs.matrix) }}
    steps:
      - name: Show build info
        run: |
          printf '%s\n' "üèóÔ∏è Building ${{ needs.compare_release.outputs.upstream_tag }} for ${{ matrix.os }}/${{ matrix.arch }}, ${UPDATE_RELEASE}"
