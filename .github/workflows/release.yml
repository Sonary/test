name: release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "version (e.g., v1.0.0)"
        required: false
        type: string
      build:
        description: "platform"
        required: true
        type: choice
        default: "all"
        options:
          - all
          - linux
          - windows
          - darwin
          - android
  schedule:
    - cron: "0 * * * *"

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ inputs.build }}
  cancel-in-progress: true

env:
  UPSTREAM_REPO: SagerNet/sing-box
  UPSTREAM_REF: dev-next
  UPSTREAM_BUILD: /.github/workflows/build.yml
  UPDATE_RELEASE: false

jobs:
  compare_release:
    name: Compare release
    runs-on: ubuntu-latest
    outputs:
      upstream_name: ${{ steps.compare_release.outputs.upstream_name }}
      upstream_tag: ${{ steps.compare_release.outputs.upstream_tag }}
      local_name: ${{ steps.compare_release.outputs.local_name }}
      local_tag: ${{ steps.compare_release.outputs.local_tag }}
      matrix: ${{ steps.get_matrix.outputs.matrix }}
    steps:
      - name: Compare release
        id: compare_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          INPUT_VERSION: ${{ inputs.version }}
          CONTINUE: true
        continue-on-error: true
        run: |
          get_release()
          {
              repo=$1
              tags=${2:+tags/}${2:-latest}
              curl -s "https://api.github.com/repos/${repo}/releases/${tags}" \
                   -H "Accept: application/vnd.github+json" \
                   -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                   -H "X-GitHub-Api-Version: 2022-11-28" | \
              jq -crM '
                  (
                      select(.draft == false and .prerelease == false) |
                      .name, .tag_name, .published_at
                  ) // (
                      "None", "None", "None"
                  )
              ' 2>/dev/null || \
              printf '%s\n' "None" "None" "None"
          }

          vercomp()
          {
              ver1=$1 ver2=$2 pad=

              IFS=.
              set -- $ver1 $ver2
              i=0
              while [ $i -lt $# ]
              do
                  pad=$pad.0
                  : $(( i+=1 ))
              done

              set -- $ver2
              for v in $ver1 $pad
              do
                  unset IFS

                  if [ ${v:-0} -gt ${1:-0} ]
                  then
                      return 1
                  elif [ ${v:-0} -lt ${1:-0} ]
                  then
                      return 2
                  elif [ $# -eq 0 ]
                  then
                      return 0
                  fi
                  shift
              done
          }

          IFS="
          "
          set -- $(
              get_release "$UPSTREAM_REPO" "$INPUT_VERSION"
              get_release "${{ github.repository }}" "$INPUT_VERSION"
          )

          cat << EOF
          Event trigger: ${{ github.event_name }}

          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Release Comparison                                           ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ Repository  ‚îÇ Name       ‚îÇ Tag        ‚îÇ Date                 ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ-‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ Upstream    ‚îÇ $( printf '%-10s ‚îÇ %-10s ‚îÇ %-20s ‚îÇ\n' "$1" "$2" "$3" )
          ‚îÇ Local       ‚îÇ $( printf '%-10s ‚îÇ %-10s ‚îÇ %-20s ‚îÇ\n' "$4" "$5" "$6" )
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

          EOF

          if [ "$1" = "None" ]
          then
              printf '%s\n' "‚ùå Upstream release not found: ${INPUT_VERSION:-$1}"
              exit 1
          elif [ "$4" != "None" ]
          then
              vercomp "$1" "$4"
              if [ -z "$INPUT_VERSION" ] && [ $? -ne 1 ]
              then
                  printf '%s\n' "‚úÖ Already up to date"
                  printf '%s\n' "CONTINUE=false" >> "$GITHUB_ENV"
                  exit 0
              elif [ -n "$INPUT_VERSION" ] && [ $? -eq 0 ]
              then
                  printf '%s\n' "üöÄ Update release: $1"
                  UPDATE_RELEASE=true
              fi
          fi
          printf '%s\n' "üöÄ New release available: $1"

          printf '%s\n' "upstream_name=$1" \
                        "upstream_tag=$2" \
                        "local_name=$4" \
                        "local_tag=$5" >> "$GITHUB_OUTPUT"

          printf '%s\n' "UPDATE_RELEASE=$UPDATE_RELEASE" >> "$GITHUB_ENV"
      - name: Get build matrix
        if: ${{ steps.compare_release.outcome == 'success' || env.CONTINUE == 'true' }}
        id: get_matrix
        env:
          INPUT_BUILD: ${{ inputs.build }}
        run: |
          UPSTREAM_BUILD=${UPSTREAM_REPO}/raw/${UPSTREAM_REF}${UPSTREAM_BUILD}

          if ! matrix=$(
              curl -fsSL "https://github.com/$UPSTREAM_BUILD" | \
              yq -rM '.jobs.build.strategy.matrix.include | @json' | \
              jq -e -crM --arg os "${INPUT_BUILD:-all}" '
                  if $os == "all" then . else map(select(.os == $os)) end |
                  if length > 0 then . else empty end
              '
          )
          then
              printf '%s\n' "‚ùå Upstream build not found: ${INPUT_BUILD:-all}"
              exit 1
          fi

          cat << EOF
          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
          ‚îÇ Build Matrix                                                                                            ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          ‚îÇ os         ‚îÇ arch                                                                                       ‚îÇ
          ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
          $(
              printf '%s' "$matrix" | \
              jq -r '
                  group_by(.os) |
                  sort_by(.[0].os) |
                  .[] |
                  "| " +
                  (.[0].os + " " * 10)[:10] +
                  " | " +
                  ([.[].arch] | unique | join(", ") | . + " " * 90)[:90] +
                  " |"
              '
          )
          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          EOF

          printf '%s\n' "matrix=$matrix" >> "$GITHUB_OUTPUT"
  build:
    name: Build binary
    runs-on: ubuntu-latest
    needs:
      - compare_release
    strategy:
      matrix:
        include: ${{ fromJson(needs.compare_release.outputs.matrix) }}
    steps:
      - name: Show build info
        if: ${{ needs.compare_release.outputs.matrix != '' }}
        run: |
          printf '%s\n' "üèóÔ∏è Building ${{ needs.compare_release.outputs.upstream_tag }} for ${{ matrix.os }}/${{ matrix.arch }}, ${UPDATE_RELEASE}"
